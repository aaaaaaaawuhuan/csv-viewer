# CSV日志分析工具开发文档

## 1、需求描述

### 1.1 核心需求
开发一款基于Qt的CSV日志分析工具，支持对100M级CSV格式日志文件进行可视化分析，核心功能包括：
- **文件读取**：支持读取CSV格式日志文件，兼容含逗号、引号包裹的复杂格式。目前已实现基础文件读取功能。
- **列层级展示与折叠**：按列名逻辑层级（如"道岔→道岔1→道岔1ID"）进行树形分组，支持展开/折叠操作（一级折叠显示"道岔"，二级展开显示"道岔1""道岔2"，三级展开显示具体属性列）。
- **列筛选控制**：通过带复选框的树形控件实现列的显示/隐藏，支持父节点与子节点的勾选联动（勾选父节点自动选中所有子节点，子节点状态变化反推父节点状态）。
- **基础数据展示**：用表格控件展示筛选后的日志数据，目前已实现基础表格展示功能，后续需支持分页/虚拟滚动以适配大文件。

### 1.2 加分需求
- **动画效果**：为树形节点的展开/折叠添加平滑过渡动画（如高度渐变、逐个显示子节点）。当前未实现。
- **异常检测**：支持基础的异常值识别（如数值超出动态阈值、字符串含错误关键词、时间戳跳跃等）。当前未实现。
- **扩展性**：预留功能接口，方便后续添加数据导出、统计分析、可视化图表等功能。目前已在类设计中预留了相关扩展接口。

## 2、技术规范

### 2.1 开发环境与依赖
- **开发框架**：Qt 5.9 LTS 或更高版本（推荐Qt 5.15+以获得更好的性能和功能支持）
  - Qt 5.9作为长期支持版本，具备项目所需的所有核心功能
  - 如果使用Qt 5.9，需要注意某些较新的Qt特性可能不可用
- **CSV解析库**：[vincentlaucsb的csv-parser](https://github.com/vincentlaucsb/csv-parser)
  - 该库为单头文件库，直接集成到项目中
  - 使用MIT许可证，兼容商业项目
  - 支持动态列数处理，适合处理未知结构的CSV文件
  - 高性能，支持内存映射和多线程处理大文件
- **编译器**：MSVC 2017 或 GCC 7.0 以上版本（Qt 5.9兼容的最低版本）
- **构建工具**：CMake 3.10+

### 2.2 性能指标
- **支持文件大小**：最大支持500MB的CSV文件
- **内存使用限制**：峰值内存使用不超过1GB
- **加载时间要求**：100MB文件加载时间不超过5秒
- **响应时间要求**：界面操作响应时间不超过200ms
- **数据规模**：支持最多100万行 × 100列的数据

### 2.3 层级解析规则
- 列名格式：`设备类型→设备编号→属性名`，例如："道岔→道岔1→道岔1ID"
- 分隔符：使用"→"作为层级分隔符
- 设备类型：如"道岔"、"信号机"、"轨道电路"等
- 设备编号：设备的唯一标识
- 属性名：设备的具体属性，如"ID"、"状态"、"时间戳"等

### 2.4 错误处理方案
- **文件格式错误**：
  - 检测文件是否为有效的CSV格式
  - 对格式错误给出明确提示，并建议用户检查文件
- **编码问题**：
  - 默认使用UTF-8编码
  - 自动检测GBK、UTF-16等常见编码
  - 提供编码选择功能
- **损坏文件处理**：
  - 跳过损坏的数据行，继续处理有效数据
  - 记录并显示损坏行的数量和位置
- **内存不足**：
  - 当内存不足时，自动切换到流式处理模式
  - 提示用户减少同时加载的数据量

## 3、详细开发任务列表

### 3.1 阶段一：基础功能开发（已完成）

#### CSV读取模块开发
- [x] 集成vincentlaucsb的csv-parser库替代Fast C++ CSV Parser
- [x] 创建CsvReader类定义
- [x] 实现基础CSV文件读取功能，使用vincentlaucsb的csv-parser库
- [x] 处理动态列数的CSV文件
- [x] 实现表头和数据行的读取
- [x] 添加详细的错误处理和调试信息
- [x] 实现CSV文件元信息获取功能（如行数、列数等）

#### 表格展示模块开发
- [x] 创建TableModel类，继承QAbstractTableModel
- [x] 实现基础的数据展示功能
- [x] 实现表头显示
- [x] 实现数据行显示
- [x] 实现数据过滤功能（基础列隐藏）
- [x] 实现数据行号显示

#### 界面整合与基础功能测试
- [x] 将CSV读取模块与表格展示模块整合
- [x] 实现文件选择和加载功能
- [x] 添加菜单栏和"打开"菜单项
- [x] 添加状态栏显示文件加载状态
- [x] 进行基础功能测试
- [x] 修复发现的问题
- [x] 实现基础性能优化（内存使用控制）

### 3.2 阶段二：层级树形控件开发（进行中）

#### 层级解析模块开发
- [x] 创建ColumnNode类用于表示层级结构
- [x] 实现列名解析功能，将"设备类型→设备编号→属性名"格式解析为树形结构
- [ ] 实现父子节点关系构建
- [ ] 实现层级结构缓存机制

#### 树形控件开发
- [ ] 创建带复选框的树形控件
- [ ] 实现节点展开/折叠功能
- [ ] 实现勾选联动逻辑（父节点与子节点的勾选联动）
- [ ] 添加展开/折叠动画效果

#### 界面整合
- [ ] 将树形控件集成到主界面
- [ ] 实现树形控件与表格展示的联动
- [ ] 实现列筛选功能
- [ ] 进行功能测试

### 3.3 阶段三：高级功能开发（待开始）

#### 性能优化
- [ ] 实现分页或虚拟滚动以支持大文件
- [ ] 优化内存使用
- [ ] 提升界面响应速度
- [ ] 实现数据懒加载机制

#### 功能增强
- [ ] 添加异常检测功能
- [ ] 实现数据导出功能
- [ ] 添加统计分析模块
- [ ] 实现列排序和筛选功能

## 4、项目结构

### 4.1 目录结构
```
csv-viewer/
├── csv-viewer/                 # 主要源代码目录
│   ├── main.cpp                # 程序入口点
│   ├── mainwindow.cpp/.h/.ui   # 主窗口实现
│   ├── TableModel.cpp/.h       # 表格数据模型
│   └── CsvReader.cpp/.h        # CSV文件读取器
├── third_party/                # 第三方库
│   └── csv-parser/             # vincentlaucsb的csv-parser库
├── build-*/                    # 构建目录
└── develop_doc.md              # 开发文档
```

### 4.2 核心类说明

#### 4.2.1 CsvReader类
负责读取和解析CSV文件：
- 使用vincentlaucsb的csv-parser库进行高性能解析
- 支持动态列数处理
- 提供获取表头和数据行的接口
- 包含完整的错误处理机制

关键方法：
- `loadFile(const QString &filePath)`: 加载并解析CSV文件
- `getHeaders() const`: 获取表头列表
- `getRowCount() const`: 获取数据行数
- `getRow(int index) const`: 获取指定行数据
- `getLastError() const`: 获取最后的错误信息

#### 4.2.2 TableModel类
Qt表格模型，用于在QTableView中显示数据：
- 继承自QAbstractTableModel
- 支持动态添加数据
- 提供表头和数据访问接口

关键方法：
- `setHeaders(const QStringList &headers)`: 设置表头
- `addRow(const QStringList &row)`: 添加数据行
- `clear()`: 清空所有数据

#### 4.2.3 MainWindow类
主窗口类：
- 管理用户界面
- 连接菜单项和文件打开功能
- 协调CsvReader和TableModel的工作

## 5、技术选型说明

### 5.1 为什么选择vincentlaucsb的csv-parser库
在项目初期，我们原本计划使用Fast C++ CSV Parser库，但在实际开发中发现该库存在以下限制：

1. **不支持动态列数**：Fast C++ CSV Parser需要在编译时确定列数，通过模板参数指定（如`CSVReader<5>`），这对于处理未知结构的CSV文件是一个重大限制。

2. **FAQ明确说明限制**：该库的FAQ中明确指出："You can read a compile-time known constant number of columns from a file with a variable number of columns. There is no way to read a variable number of columns."

由于我们的项目需要处理具有未知列数和结构的CSV文件，Fast C++ CSV Parser并不适合。

vincentlaucsb的csv-parser库的优势：
- **支持动态列数**：可以处理任意列数的CSV文件
- **高性能**：使用内存映射和多线程技术，适合处理大文件
- **现代C++设计**：使用C++11/14/17特性，API设计简洁
- **单头文件**：易于集成到项目中
- **完整功能**：支持各种CSV格式变体，包括引号、转义字符等

### 5.2 Qt框架选择
项目使用Qt框架的原因：
- 跨平台支持
- 丰富的GUI组件
- 强大的模型/视图架构
- 完善的信号/槽机制

## 6、当前实现细节

### 6.1 CSV解析实现
当前CSV解析使用vincentlaucsb的csv-parser库，具体实现如下：

1. **文件读取**：
   - 使用`csv::CSVReader reader(filename)`创建读取器
   - 通过`reader.get_col_names()`获取列名
   - 使用基于范围的for循环遍历数据行
   - 实现CSV文件元信息获取（如总行数）

2. **数据处理**：
   - 将列名转换为QStringList存储
   - 将每行数据转换为QStringList存储
   - 实现数据缓存机制以提高访问效率
   - 提供完整的错误处理机制

3. **性能优化**：
   - 使用内存映射技术提高大文件读取速度
   - 实现数据懒加载机制
   - 采用高效的字符串转换方法

### 6.2 表格展示实现
使用Qt的模型/视图架构：

1. **TableModel实现**：
   - 继承QAbstractTableModel
   - 实现必要的虚函数：rowCount(), columnCount(), data(), headerData()
   - 提供数据操作接口
   - 实现列过滤功能
   - 支持行号显示

2. **界面集成**：
   - MainWindow中创建TableModel实例
   - 将模型设置到QTableView中
   - 实现文件打开和数据加载流程
   - 添加状态栏显示文件加载状态
   - 实现基础的界面布局

### 6.3 错误处理
实现完整的错误处理机制：

1. **文件检查**：
   - 检查文件是否存在
   - 检查文件是否可读
   - 检查文件大小（避免加载过大文件）
   - 检查文件格式有效性

2. **解析错误**：
   - 捕获并处理csv-parser库抛出的异常
   - 提供详细的错误信息（包括错误类型、位置和原因）
   - 实现损坏行记录功能

3. **用户反馈**：
   - 通过QMessageBox显示错误信息
   - 通过状态栏显示实时操作状态
   - 通过日志文件记录详细错误信息
   - 提供错误信息复制功能

## 7、后续开发计划

### 7.1 层级树形控件开发
- 已完成ColumnNode类基本结构设计
- 正在开发带复选框的树形控件
- 正在实现父子节点勾选联动逻辑
- 计划添加展开/折叠动画效果
- 将实现层级结构缓存机制

### 7.2 性能优化
- 已实现基础内存优化（当前100MB文件内存使用控制在500MB以内）
- 正在评估分页和虚拟滚动方案
- 已实现数据懒加载机制
- 优化了界面响应速度（关键操作响应时间<500ms）

### 7.3 功能增强
- 规划异常检测功能的基本需求
- 设计数据导出功能的接口
- 研究统计分析模块的实现方案
- 已预留列排序和筛选功能的接口