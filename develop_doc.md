# CSV日志分析工具开发文档

## 1、需求描述

### 1.1 核心需求
开发一款基于Qt的CSV日志分析工具，支持对100M级CSV格式日志文件进行可视化分析，核心功能包括：
- **文件读取**：支持读取CSV格式日志文件，兼容含逗号、引号包裹的复杂格式。
- **列层级展示与折叠**：按列名逻辑层级（如"道岔→道岔1→道岔1ID"）进行树形分组，支持展开/折叠操作（一级折叠显示"道岔"，二级展开显示"道岔1""道岔2"，三级展开显示具体属性列）。
- **列筛选控制**：通过带复选框的树形控件实现列的显示/隐藏，支持父节点与子节点的勾选联动（勾选父节点自动选中所有子节点，子节点状态变化反推父节点状态）。
- **基础数据展示**：用表格控件展示筛选后的日志数据，支持分页/虚拟滚动以适配大文件。

### 1.2 加分需求
- **动画效果**：为树形节点的展开/折叠添加平滑过渡动画（如高度渐变、逐个显示子节点）。
- **异常检测**：支持基础的异常值识别（如数值超出动态阈值、字符串含错误关键词、时间戳跳跃等）。
- **扩展性**：预留功能接口，方便后续添加数据导出、统计分析、可视化图表等功能。

## 2、技术规范

### 2.1 开发环境与依赖
- **开发框架**：Qt 5.9 LTS 或更高版本（推荐Qt 5.15+以获得更好的性能和功能支持）
  - Qt 5.9作为长期支持版本，具备项目所需的所有核心功能
  - 如果使用Qt 5.9，需要注意某些较新的Qt特性可能不可用
- **CSV解析库**：FastCsvParser (https://github.com/ben-strasser/fast-cpp-csv-parser)
  - 该库为单头文件库，直接集成到项目中
  - 使用MIT许可证，兼容商业项目
- **编译器**：MSVC 2017 或 GCC 7.0 以上版本（Qt 5.9兼容的最低版本）
- **构建工具**：CMake 3.10+

### 2.2 性能指标
- **支持文件大小**：最大支持500MB的CSV文件
- **内存使用限制**：峰值内存使用不超过1GB
- **加载时间要求**：100MB文件加载时间不超过5秒
- **响应时间要求**：界面操作响应时间不超过200ms
- **数据规模**：支持最多100万行 × 100列的数据

### 2.3 层级解析规则
- 列名格式：`设备类型→设备编号→属性名`，例如："道岔→道岔1→道岔1ID"
- 分隔符：使用"→"作为层级分隔符
- 设备类型：如"道岔"、"信号机"、"轨道电路"等
- 设备编号：设备的唯一标识
- 属性名：设备的具体属性，如"ID"、"状态"、"时间戳"等

### 2.4 错误处理方案
- **文件格式错误**：
  - 检测文件是否为有效的CSV格式
  - 对格式错误给出明确提示，并建议用户检查文件
- **编码问题**：
  - 默认使用UTF-8编码
  - 自动检测GBK、UTF-16等常见编码
  - 提供编码选择功能
- **损坏文件处理**：
  - 跳过损坏的数据行，继续处理有效数据
  - 记录并显示损坏行的数量和位置
- **内存不足**：
  - 当内存不足时，自动切换到流式处理模式
  - 提示用户减少同时加载的数据量

## 3、详细开发任务列表

### 3.1 阶段一：基础功能开发（预计2周，14天）

#### 第1-2天：环境搭建与项目初始化
- [ ] 安装Qt 5.9开发环境
- [ ] 创建项目目录结构
- [ ] 配置CMakeLists.txt文件
- [ ] 集成FastCsvParser库到项目中
- [ ] 创建基础的mainwindow.ui界面文件
- [ ] 编写项目README文档

#### 第3-5天：CSV读取模块开发
- [ ] 创建CsvReader类定义
- [ ] 实现基础CSV文件读取功能
- [ ] 处理带引号的字段
- [ ] 处理转义字符
- [ ] 实现动态识别列数和表头
- [ ] 编写CsvReader类的基础功能测试

#### 第6-9天：表格展示模块开发
- [ ] 创建TableModel类，继承QAbstractTableModel
- [ ] 实现基础的数据展示功能
- [ ] 实现虚拟滚动以支持大文件
- [ ] 实现表格的基本交互（选择、滚动等）
- [ ] 优化表格渲染性能
- [ ] 编写TableModel类的基础功能测试

#### 第10-12天：界面整合与基础功能测试
- [ ] 将CSV读取模块与表格展示模块整合
- [ ] 实现文件选择和加载功能
- [ ] 添加基础的用户界面元素（菜单、工具栏等）
- [ ] 进行基础功能测试
- [ ] 修复发现的问题

#### 第13-14天：性能优化与文档编写
- [ ] 进行初步的性能测试
- [ ] 根据测试结果进行优化
- [ ] 编写阶段一的开发文档
- [ ] 准备阶段一的交付物

### 3.2 阶段二：层级树形控件开发（预计3周，21天）

#### 第1-4天：层级解析模块开发
- [ ] 创建ColumnHierarchyParser类定义
- [ ] 实现列名层级解析算法
- [ ] 开发正则表达式提取功能（设备类型、编号、属性）
- [ ] 创建树形数据结构（ColumnNode）
- [ ] 实现多级节点构建逻辑
- [ ] 编写层级解析模块的基础功能测试

#### 第5-9天：树形控件基础功能开发
- [ ] 创建CheckableTreeWidget类，继承QTreeWidget
- [ ] 实现基础的树形节点展示
- [ ] 添加复选框到每个节点
- [ ] 实现节点的展开/折叠功能
- [ ] 实现基本的节点样式和布局
- [ ] 编写树形控件的基础功能测试

#### 第10-13天：勾选联动逻辑开发
- [ ] 实现父节点控制子节点全选/全不选
- [ ] 实现子节点状态反推父节点状态
- [ ] 添加"部分选中"状态支持
- [ ] 优化勾选联动的性能
- [ ] 进行勾选联动功能测试
- [ ] 修复发现的问题

#### 第14-17天：表格列显示控制开发
- [ ] 实现树形控件勾选状态与表格列显示/隐藏的绑定
- [ ] 实现通过树形节点快速筛选目标列功能
- [ ] 优化列显示/隐藏的性能
- [ ] 添加列显示状态的保存和恢复功能
- [ ] 进行表格列控制功能测试
- [ ] 修复发现的问题

#### 第18-21天：整合测试与优化
- [ ] 将层级解析模块、树形控件和表格展示模块整合
- [ ] 进行全面的功能测试
- [ ] 根据测试结果进行优化
- [ ] 编写阶段二的开发文档
- [ ] 准备阶段二的交付物

### 3.3 阶段三：动画与交互优化（预计2周，14天）

#### 第1-4天：动画模块开发
- [ ] 创建AnimatedTreeWidget类，继承QTreeWidget
- [ ] 研究Qt动画框架（QPropertyAnimation）
- [ ] 实现节点展开/折叠的整体高度渐变动画
- [ ] 实现子节点逐个显示的动画效果
- [ ] 添加动画参数配置（时长、缓动函数等）
- [ ] 编写动画模块的基础功能测试

#### 第5-8天：交互细节优化
- [ ] 为树形控件添加"全选/全不选"按钮
- [ ] 实现快速筛选功能
- [ ] 优化节点展开/折叠的响应速度
- [ ] 添加动画开关选项
- [ ] 进行交互功能测试
- [ ] 修复发现的问题

#### 第9-11天：性能优化
- [ ] 进行动画性能测试
- [ ] 优化动画流畅度（控制在200-300ms内）
- [ ] 根据不同性能需求调整动画效果
- [ ] 进行低性能设备上的兼容性测试
- [ ] 优化内存使用

#### 第12-14天：整合测试与文档编写
- [ ] 将动画模块与现有功能整合
- [ ] 进行全面的功能和性能测试
- [ ] 根据测试结果进行优化
- [ ] 编写阶段三的开发文档
- [ ] 准备阶段三的交付物

### 3.4 阶段四：扩展功能与测试（预计2周，14天）

#### 第1-4天：异常检测模块开发
- [ ] 创建异常检测模块
- [ ] 实现数值型列检测（均值±2倍标准差法）
- [ ] 实现字符串型列检测（关键词匹配）
- [ ] 实现时间戳异常检测
- [ ] 在表格中实现异常单元格高亮显示
- [ ] 编写异常检测模块的基础功能测试

#### 第5-8天：测试与优化
- [ ] 准备测试用的CSV文件（不同大小）
- [ ] 进行压力测试（100M级文件）
- [ ] 监控内存使用情况
- [ ] 根据测试结果进行性能优化
- [ ] 修复功能bug
- [ ] 优化用户体验

#### 第9-12天：功能完善与用户体验优化
- [ ] 完善用户手册（含功能说明与操作步骤）
- [ ] 添加必要的帮助文档
- [ ] 优化界面布局和交互细节
- [ ] 添加必要的配置选项
- [ ] 进行最终的功能测试
- [ ] 修复发现的问题

#### 第13-14天：最终测试与交付准备
- [ ] 进行最终的全面测试
- [ ] 编写测试报告
- [ ] 整理项目文档和源码
- [ ] 准备完整的交付物
- [ ] 编写阶段四的开发文档
- [ ] 项目总结

## 4、测试策略

由于这是个人开发项目，测试策略相对简化：

### 4.1 基础功能测试
- 手动测试核心功能是否正常工作
- 验证基本的CSV文件读取和显示功能
- 检查层级树形控件的基本交互

### 4.2 性能验证
- 使用典型大小的CSV文件（10MB、50MB、100MB）验证加载和浏览性能
- 确保内存使用在合理范围内

### 4.3 错误处理验证
- 测试对格式错误、编码问题等异常情况的处理
- 验证程序在异常输入下的稳定性和提示信息

## 5、风险评估与应对措施

### 5.1 技术风险
- **CSV解析性能问题**：
  - 风险：大文件解析可能导致内存占用过高或解析速度慢
  - 应对：采用流式解析，分块加载数据
- **虚拟滚动实现复杂**：
  - 风险：QTableView的虚拟滚动实现可能遇到性能瓶颈
  - 应对：深入研究Qt的模型/视图架构，必要时采用第三方解决方案

### 5.2 进度风险
- **层级解析算法复杂**：
  - 风险：复杂的列名层级解析可能耗时较长
  - 应对：先实现基础解析功能，后续再优化算法
- **动画效果实现困难**：
  - 风险：平滑动画效果可能影响性能
  - 应对：提供动画开关选项，允许用户根据性能需求选择