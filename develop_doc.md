# CSV日志分析工具开发文档

## 1、需求描述

### 1.1 核心需求
开发一款基于Qt的CSV日志分析工具，支持对100M级CSV格式日志文件进行可视化分析，核心功能包括：
- **文件读取**：支持读取CSV格式日志文件，兼容含逗号、引号包裹的复杂格式。已实现基础文件读取功能。
- **编码处理**：支持UTF-8、GBK编码，并提供自动检测编码功能。
- **基础数据展示**：用表格控件展示日志数据，已实现基础表格展示功能。

### 1.2 加分需求
- **列层级展示与折叠**：按列名逻辑层级进行树形分组，支持展开/折叠操作。
- **列筛选控制**：通过带复选框的树形控件实现列的显示/隐藏，支持父节点与子节点的勾选联动。
- **动画效果**：为树形节点的展开/折叠添加平滑过渡动画。
- **异常检测**：支持基础的异常值识别。
- **扩展性**：预留功能接口，方便后续添加数据导出、统计分析、可视化图表等功能。

## 2、技术规范

### 2.1 开发环境与依赖
- **开发框架**：Qt 6.5
  - 使用Qt 6.5版本开发，利用其最新特性和性能优化
- **CSV解析库**：[vincentlaucsb的csv-parser](https://github.com/vincentlaucsb/csv-parser)
  - 该库为单头文件库，直接集成到项目中
  - 使用MIT许可证，兼容商业项目
  - 支持动态列数处理，适合处理未知结构的CSV文件
  - 高性能，支持内存映射和多线程处理大文件
- **编译器**：MinGW 64位 (Qt 6.5自带)
- **构建工具**：CMake 3.10+

### 2.2 性能指标
- **支持文件大小**：最大支持500MB的CSV文件
- **内存使用限制**：峰值内存使用不超过1GB
- **加载时间要求**：100MB文件加载时间不超过5秒
- **响应时间要求**：界面操作响应时间不超过200ms
- **数据规模**：支持最多100万行 × 100列的数据

### 2.3 编码处理方案
- **默认编码**：UTF-8
- **支持编码**：UTF-8、GBK
- **自动检测**：通过检查UTF-8替换字符(0xFFFD)出现频率来判断文件编码
- **编码选择**：提供用户界面让用户手动选择文件编码

### 2.4 错误处理方案
- **文件格式错误**：
  - 检测文件是否为有效的CSV格式
  - 对格式错误给出明确提示，并建议用户检查文件
- **编码问题**：
  - 提供编码选择功能，允许用户手动指定文件编码
  - 自动检测常见编码
- **损坏文件处理**：
  - 跳过损坏的数据行，继续处理有效数据
  - 记录并显示损坏行的数量和位置
- **内存不足**：
  - 当内存不足时，自动切换到流式处理模式
  - 提示用户减少同时加载的数据量

## 3、详细开发任务列表

### 3.1 阶段一：基础功能开发（已完成）

#### CSV读取模块开发
- [x] 集成vincentlaucsb的csv-parser库
- [x] 创建CsvReader类定义
- [x] 实现基础CSV文件读取功能
- [x] 处理动态列数的CSV文件
- [x] 实现表头和数据行的读取
- [x] 添加详细的错误处理和调试信息
- [x] 实现CSV文件元信息获取功能（如行数、列数等）
- [x] 实现多种编码支持（UTF-8、GBK）和自动检测功能
- [x] 移除对QTextCodec的依赖，使用QString::fromLocal8Bit替代
- [x] 实现延迟加载机制，支持大文件的部分加载
- [x] 添加流式处理功能，支持滚动加载更多数据
- [x] 优化内存预分配和使用

#### 表格展示模块开发
- [x] 创建TableModel类，继承QAbstractTableModel
- [x] 实现基础的数据展示功能
- [x] 实现表头显示
- [x] 实现数据行显示
- [x] 实现数据过滤功能（基础列隐藏）
- [x] 实现数据行号显示

#### 界面整合与基础功能测试
- [x] 将CSV读取模块与表格展示模块整合
- [x] 实现文件选择和加载功能
- [x] 添加菜单栏和"打开"菜单项
- [x] 添加状态栏显示文件加载状态
- [x] 进行基础功能测试
- [x] 修复发现的问题
- [x] 实现基础性能优化（内存使用控制）
- [x] 添加编码选择菜单，支持UTF-8、GBK和自动检测

### 3.2 阶段二：层级树形控件开发（待开始）

#### 层级解析模块开发
- [ ] 创建ColumnNode类用于表示层级结构
- [ ] 实现列名解析功能
- [ ] 实现父子节点关系构建
- [ ] 实现层级结构缓存机制

#### 树形控件开发
- [ ] 创建带复选框的树形控件
- [ ] 实现节点展开/折叠功能
- [ ] 实现勾选联动逻辑（父节点与子节点的勾选联动）
- [ ] 添加展开/折叠动画效果

#### 界面整合
- [ ] 将树形控件集成到主界面
- [ ] 实现树形控件与表格展示的联动
- [ ] 实现列筛选功能
- [ ] 进行功能测试

### 3.3 阶段三：高级功能开发（待开始）

#### 性能优化
- [ ] 实现分页或虚拟滚动以支持大文件
- [ ] 优化内存使用
- [ ] 提升界面响应速度
- [ ] 实现数据懒加载机制

#### 功能增强
- [ ] 添加异常检测功能
- [ ] 实现数据导出功能
- [ ] 添加统计分析模块
- [ ] 实现列排序和筛选功能

## 4、项目结构

### 4.1 目录结构
```
csv-viewer/
├── csv-viewer/                 # 主要源代码目录
│   ├── main.cpp                # 程序入口点
│   ├── mainwindow.cpp/.h/.ui   # 主窗口实现
│   ├── TableModel.cpp/.h       # 表格数据模型
│   └── CsvReader.cpp/.h        # CSV文件读取器
├── third_party/                # 第三方库
│   └── csv-parser/             # vincentlaucsb的csv-parser库
├── build-*/                    # 构建目录
└── develop_doc.md              # 开发文档
```

### 4.2 核心类说明

#### 4.2.1 CsvReader类
负责读取和解析CSV文件：
- 使用vincentlaucsb的csv-parser库进行高性能解析
- 支持动态列数处理
- 提供获取表头和数据行的接口
- 包含完整的错误处理机制
- 支持多种编码处理（UTF-8、GBK）和自动检测功能

关键方法：
- `loadFile(const QString &filePath)`: 加载并解析CSV文件，支持初始加载行数限制
- `getHeaders() const`: 获取表头列表
- `getRowCount() const`: 获取当前已加载的数据行数
- `getRow(int index) const`: 获取指定行数据
- `getRowsRange(int startIndex, int count) const`: 获取指定范围的数据行
- `getLastError() const`: 获取最后的错误信息
- `setEncoding(Encoding encoding)`: 设置编码模式
- `getEncoding() const`: 获取当前编码模式
- `hasMoreData() const`: 检查是否还有未加载的数据
- `getEstimatedTotalRows() const`: 获取估计的总行数
- `loadMoreRows(int count)`: 加载更多数据行
- `getLastLoadedRowIndex() const`: 获取最后加载的行索引

编码模式枚举：
- `UTF8`: 使用UTF-8编码
- `GBK`: 使用GBK编码
- `AutoDetect`: 自动检测编码

#### 4.2.2 TableModel类
Qt表格模型，用于在QTableView中显示数据：
- 继承自QAbstractTableModel
- 支持动态添加数据
- 提供表头和数据访问接口

关键方法：
- `setHeaders(const QStringList &headers)`: 设置表头
- `addRow(const QStringList &row)`: 添加数据行
- `clear()`: 清空所有数据

#### 4.2.3 MainWindow类
主窗口类：
- 管理用户界面
- 连接菜单项和文件打开功能
- 协调CsvReader和TableModel的工作
- 提供编码选择菜单
- 实现文件重新加载功能

关键方法：
- `loadCsvFile(const QString &filePath)`: 加载CSV文件
- `displayCsvData(bool loadAll = false)`: 显示CSV数据，参数控制是否加载全部数据
- `loadMoreRows()`: 加载更多数据行，用于滚动到底部时触发
- `createEncodingMenu()`: 创建编码选择菜单
- `reloadCurrentFileIfNeeded()`: 重新加载当前文件（当编码改变时）

## 5、技术选型说明

### 5.1 为什么选择vincentlaucsb的csv-parser库
- **支持动态列数**：可以处理任意列数的CSV文件
- **高性能**：使用内存映射和多线程技术，适合处理大文件
- **现代C++设计**：使用C++11/14/17特性，API设计简洁
- **单头文件**：易于集成到项目中
- **完整功能**：支持各种CSV格式变体，包括引号、转义字符等

### 5.2 Qt框架选择
项目使用Qt框架的原因：
- 跨平台支持
- 丰富的GUI组件
- 强大的模型/视图架构
- 完善的信号/槽机制

### 5.3 编码处理方案说明
为了避免使用已弃用的QTextCodec类和Qt6::Core5Compat模块，项目采用了以下编码处理方案：
- UTF-8编码：直接使用标准的UTF-8解码
- GBK编码：使用QString::fromLocal8Bit进行解码
- 自动检测：通过检查UTF-8替换字符(0xFFFD)的出现频率来判断文件编码

这种方案不需要依赖Qt6::Core5Compat模块，提高了代码的兼容性和可维护性。

## 6、当前实现细节

### 6.1 CSV解析实现
当前CSV解析使用vincentlaucsb的csv-parser库，具体实现如下：

1. **文件读取**：
   - 使用`csv::CSVReader reader(filename)`创建读取器
   - 通过`reader.get_col_names()`获取列名
   - 支持初始加载行数限制，默认限制为10000行
   - 实现流式处理，支持后续按需加载更多数据
   - 实现CSV文件元信息获取（如总行数）
   - 保存文件内容备份，用于后续加载更多数据

2. **编码处理**：
   - UTF-8模式：直接使用标准UTF-8解码
   - GBK模式：使用QString::fromLocal8Bit进行解码
   - 自动检测模式：通过检查UTF-8替换字符(0xFFFD)的出现频率来选择合适的编码

3. **数据处理**：
   - 将列名转换为QStringList存储
   - 将每行数据转换为QStringList存储
   - 实现数据缓存机制以提高访问效率
   - 提供完整的错误处理机制
   - 实现延迟加载机制，记录已加载行位置

4. **性能优化**：
   - 使用高效的字符串转换方法
   - 实现异常处理机制
   - 优化编码检测算法
   - 预分配容器大小，减少内存重分配
   - 实现内存使用估算，便于监控
   - 实现流式加载，分批处理数据

### 6.2 表格展示实现
使用Qt的模型/视图架构：

1. **TableModel实现**：
   - 继承QAbstractTableModel
   - 实现必要的虚函数：rowCount(), columnCount(), data(), headerData()
   - 提供数据操作接口
   - 实现列过滤功能
   - 支持行号显示
   - 添加批量添加数据行方法，优化性能

2. **界面集成**：
   - MainWindow中创建TableModel实例
   - 将模型设置到QTableView中
   - 实现文件打开和数据加载流程
   - 添加状态栏显示文件加载状态
   - 实现基础的界面布局
   - 添加编码选择菜单
   - 实现表格视图滚动到底部时自动加载更多数据的功能
   - 添加动态加载计数和性能监控

### 6.3 性能优化效果
经过延迟加载和内存优化，当前实现的性能数据如下：

1. **加载性能**：
   - 初始加载10000行数据：行处理时间约1162ms
   - 每批次加载1250行数据：加载时间约748-1499ms（随数据量增加略有上升）
   - 库读取时间：约557ms
   - 表头处理时间：约0ms

2. **内存使用**：
   - 初始加载10000行数据：内存使用约216MB
   - 加载到25000行数据：内存使用保持稳定在约216MB

3. **UI显示性能**：
   - 初始显示5000行数据：UI显示时间约414ms
   - 滚动加载新数据时保持流畅的用户体验

4. **优化效果总结**：
   - 延迟加载机制有效降低了初始加载时间和内存占用
   - 内存预分配显著减少了内存重分配开销
   - 流式处理支持处理远超过初始加载限制的数据
   - 性能监控提供了详细的加载和处理时间数据

### 6.4 错误处理
实现完整的错误处理机制：

1. **文件检查**：
   - 检查文件是否存在
   - 检查文件是否可读
   - 检查文件大小（避免加载过大文件）
   - 检查文件格式有效性

2. **解析错误**：
   - 捕获并处理csv-parser库抛出的异常
   - 提供详细的错误信息（包括错误类型、位置和原因）
   - 实现损坏行记录功能

3. **用户反馈**：
   - 通过QMessageBox显示错误信息
   - 通过状态栏显示实时操作状态
   - 通过日志文件记录详细错误信息
   - 提供错误信息复制功能

## 7、后续开发计划

### 7.1 层级树形控件开发
- 计划创建ColumnNode类基本结构
- 计划开发带复选框的树形控件
- 计划实现父子节点勾选联动逻辑
- 计划添加展开/折叠动画效果
- 计划实现层级结构缓存机制

### 7.2 性能优化
- [x] 已实现延迟加载机制和流式处理
- [x] 已优化内存预分配和使用
- 计划实现虚拟滚动以支持超大型文件
- 计划进一步优化大数据集的渲染性能
- 计划优化表格列宽调整算法

### 7.3 功能增强
- 计划添加异常检测功能
- 计划实现数据导出功能
- 计划添加统计分析模块
- 计划实现列排序和筛选功能