# CSV日志分析工具开发文档

## 1、需求描述

### 1.1 核心需求
开发一款基于Qt的CSV日志分析工具，支持对100M级CSV格式日志文件进行可视化分析，核心功能包括：
- **文件读取**：支持读取CSV格式日志文件，兼容含逗号、引号包裹的复杂格式。
- **列层级展示与折叠**：按列名逻辑层级（如“道岔→道岔1→道岔1ID”）进行树形分组，支持展开/折叠操作（一级折叠显示“道岔”，二级展开显示“道岔1”“道岔2”，三级展开显示具体属性列）。
- **列筛选控制**：通过带复选框的树形控件实现列的显示/隐藏，支持父节点与子节点的勾选联动（勾选父节点自动选中所有子节点，子节点状态变化反推父节点状态）。
- **基础数据展示**：用表格控件展示筛选后的日志数据，支持分页/虚拟滚动以适配大文件。

### 1.2 加分需求
- **动画效果**：为树形节点的展开/折叠添加平滑过渡动画（如高度渐变、逐个显示子节点）。
- **异常检测**：支持基础的异常值识别（如数值超出动态阈值、字符串含错误关键词、时间戳跳跃等）。
- **扩展性**：预留功能接口，方便后续添加数据导出、统计分析、可视化图表等功能。

## 2、阶段描述+开发计划

### 2.1 阶段一：基础功能开发（预计1.5周）
#### 阶段目标
实现CSV文件读取与基础表格展示，完成核心数据结构设计。

#### 关键任务
1. **环境搭建**：配置Qt开发环境（Qt 5.15+），集成CSV解析库（`FastCsvParser`）。
2. **CSV读取模块**：
   - 开发`CsvReader`类，基于`FastCsvParser`实现文件解析，支持动态识别列数和表头。
   - 处理特殊格式（如引号包裹的字段、转义字符），将数据转换为Qt可识别的`QVector<QVector<QString>>`结构。
3. **表格展示模块**：
   - 使用`QTableView`+`QStandardItemModel`实现数据绑定，支持基本的表格浏览。
   - 实现虚拟滚动（`QAbstractTableModel`自定义模型），解决100M文件加载卡顿问题。

#### 交付物
- 可运行的基础版本，支持选择CSV文件并在表格中显示数据（支持滚动浏览大文件）。
- 核心模块代码（`CsvReader.cpp`、`TableModel.cpp`）及单元测试。

### 2.2 阶段二：层级树形控件开发（预计2周）
#### 阶段目标
实现列名层级解析、带复选框的树形控件及表格联动功能。

#### 关键任务
1. **层级解析模块**：
   - 开发`ColumnHierarchyParser`类，通过正则表达式提取列名中的类型（如“道岔”）、编号（如“1”）、属性（如“ID”）。
   - 生成树形层级数据结构（`ColumnNode`），支持多级节点（根节点→设备节点→属性节点）。
2. **树形控件与复选框联动**：
   - 基于`QTreeWidget`开发带复选框的树形控件，实现节点递归创建。
   - 开发勾选联动逻辑：父节点控制子节点全选/全不选，子节点状态反推父节点（支持“部分选中”状态）。
3. **表格列显示控制**：
   - 绑定树形控件勾选状态与表格列显示/隐藏（`QTableView::setColumnHidden`）。
   - 支持通过树形节点快速筛选目标列（如勾选“道岔1”显示其所有属性列）。

#### 交付物
- 带层级树形控件的工具版本，支持列名分组、勾选筛选及表格联动。
- 层级解析与树形控件代码（`ColumnHierarchyParser.cpp`、`CheckableTreeWidget.cpp`）。

### 2.3 阶段三：动画与交互优化（预计1周）
#### 阶段目标
为树形节点添加展开/折叠动画，优化用户交互体验。

#### 关键任务
1. **动画模块开发**：
   - 基于Qt动画框架（`QPropertyAnimation`）开发`AnimatedTreeWidget`类，重写节点展开/折叠事件。
   - 实现两种动画效果：整体高度渐变（子节点总高度从0到目标值）、逐个显示（子节点按顺序延迟展开）。
2. **交互细节优化**：
   - 为树形控件添加“全选/全不选”按钮，支持快速筛选。
   - 优化节点展开/折叠的响应速度，确保动画流畅（时长控制在200-300ms）。

#### 交付物
- 带动画效果的工具版本，树形节点展开/折叠时显示平滑过渡。
- 动画模块代码（`AnimatedTreeWidget.cpp`）及性能测试报告。

### 2.4 阶段四：扩展功能与测试（预计1.5周）
#### 阶段目标
实现基础异常检测功能，完成整体测试与优化。

#### 关键任务
1. **异常检测模块（基础版）**：
   - 开发数值型列检测：基于均值±2倍标准差的动态阈值法，标记超出范围的值。
   - 开发字符串型列检测：通过关键词匹配（如“error”“0xFFFFFF”）标记异常值。
   - 在表格中用颜色高亮异常单元格（红色标记严重异常，黄色标记警告）。
2. **测试与优化**：
   - 用100M级CSV文件进行压力测试，优化内存占用（目标：峰值内存≤500MB）。
   - 修复功能bug（如树形节点状态同步错误、动画卡顿等）。
   - 完善用户手册（含功能说明与操作步骤）。

#### 交付物
- 完整功能版本，支持日志读取、层级筛选、动画交互及基础异常检测。
- 测试报告、用户手册及源码归档。

### 2.5 整体开发计划时间线
| 阶段         | 时间范围       | 核心产出物                     |
|--------------|----------------|--------------------------------|
| 阶段一       | 第1-10天       | 基础CSV读取与表格展示功能       |
| 阶段二       | 第11-24天      | 层级树形控件与列筛选功能       |
| 阶段三       | 第25-31天      | 展开/折叠动画与交互优化        |
| 阶段四       | 第32-42天      | 异常检测功能与完整版本交付     |

**总计开发周期**：约6周（42天），可根据实际需求优先级调整各阶段时间。